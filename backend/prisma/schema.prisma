generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserPlan {
  FREE
  PRO
  PREMIUM
}

enum FinancialProfile {
  CONSERVATIVE
  MODERATE
  AGGRESSIVE
}

enum TransactionType {
  PIX_IN
  PIX_OUT
  PAYMENT
  TRANSFER
  CARD_PURCHASE
  DEPOSIT
  WITHDRAWAL
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum CardType {
  VIRTUAL
  PHYSICAL
}

enum CardStatus {
  ACTIVE
  BLOCKED
  CANCELLED
}

enum InsightType {
  WARNING
  TIP
  OPPORTUNITY
  ACHIEVEMENT
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  ABANDONED
}

enum GoalCategory {
  SAVINGS
  INVESTMENT
  DEBT_PAYMENT
  EMERGENCY
  TRAVEL
  OTHER
}

model User {
  id                   String           @id @default(uuid())
  email                String           @unique
  passwordHash         String           @map("password_hash")
  fullName             String           @map("full_name")
  cpf                  String?          @unique
  phone                String?
  avatarUrl            String?          @map("avatar_url")
  plan                 UserPlan         @default(FREE)
  financialProfile     FinancialProfile @default(MODERATE) @map("financial_profile")
  monthlyIncome        Decimal          @default(0) @map("monthly_income") @db.Decimal(12, 2)
  creditScore          Int              @default(0) @map("credit_score")
  onboardingCompleted  Boolean          @default(false) @map("onboarding_completed")
  aiPreference         String           @default("balanced") @map("ai_preference")
  isActive             Boolean          @default(true) @map("is_active")
  emailVerified        Boolean          @default(false) @map("email_verified")
  lastLoginAt          DateTime?        @map("last_login_at")
  createdAt            DateTime         @default(now()) @map("created_at")
  updatedAt            DateTime         @updatedAt @map("updated_at")

  // Core relations
  account       Account?
  cards         Card[]
  transactions  Transaction[]
  insights      AIInsight[]
  goals         FinancialGoal[]
  refreshTokens RefreshToken[]
  chatMessages  ChatMessage[]

  // Phase 4: PIX relations
  pixKeys          PixKey[]
  pixTransactions  PixTransaction[]
  pixLimit         PixLimit?

  // Phase 4: Open Finance relations
  openFinanceConsents    OpenFinanceConsent[]
  openFinanceConnections OpenFinanceConnection[]

  // Phase 4: Fraud & Security relations
  fraudAlerts     FraudAlert[]
  riskProfile     UserRiskProfile?
  devices         UserDevice[]
  mfaConfig       MfaConfig?

  // Phase 4: Compliance relations
  lgpdConsents          LgpdConsent[]
  dataDeletionRequests  DataDeletionRequest[]

  @@map("users")
}

model Account {
  id            String   @id @default(uuid())
  userId        String   @unique @map("user_id")
  balance       Decimal  @default(0) @db.Decimal(12, 2)
  currency      String   @default("BRL")
  accountNumber String   @unique @map("account_number")
  agencyNumber  String   @default("0001") @map("agency_number")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accounts")
}

model Card {
  id                     String     @id @default(uuid())
  userId                 String     @map("user_id")
  type                   CardType
  lastFour               String     @map("last_four")
  brand                  String     @default("Mastercard")
  status                 CardStatus @default(ACTIVE)
  limitAmount            Decimal    @default(1000) @map("limit_amount") @db.Decimal(12, 2)
  usedAmount             Decimal    @default(0) @map("used_amount") @db.Decimal(12, 2)
  isInternationalEnabled Boolean    @default(false) @map("is_international_enabled")
  isContactlessEnabled   Boolean    @default(true) @map("is_contactless_enabled")
  expiresAt              DateTime   @map("expires_at")
  createdAt              DateTime   @default(now()) @map("created_at")
  updatedAt              DateTime   @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("cards")
}

model Transaction {
  id          String            @id @default(uuid())
  userId      String            @map("user_id")
  type        TransactionType
  amount      Decimal           @db.Decimal(12, 2)
  description String
  category    String
  recipient   String?
  status      TransactionStatus @default(COMPLETED)
  metadata    Json?
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([category])
  @@map("transactions")
}

model AIInsight {
  id              String      @id @default(uuid())
  userId          String      @map("user_id")
  type            InsightType
  title           String
  message         String
  actionLabel     String?     @map("action_label")
  actionData      Json?       @map("action_data")
  estimatedImpact Decimal?    @map("estimated_impact") @db.Decimal(12, 2)
  isRead          Boolean     @default(false) @map("is_read")
  isDismissed     Boolean     @default(false) @map("is_dismissed")
  expiresAt       DateTime?   @map("expires_at")
  createdAt       DateTime    @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("ai_insights")
}

model FinancialGoal {
  id            String       @id @default(uuid())
  userId        String       @map("user_id")
  title         String
  description   String?
  targetAmount  Decimal      @map("target_amount") @db.Decimal(12, 2)
  currentAmount Decimal      @default(0) @map("current_amount") @db.Decimal(12, 2)
  deadline      DateTime?
  category      GoalCategory
  status        GoalStatus   @default(ACTIVE)
  icon          String?
  color         String?
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("financial_goals")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model ChatMessage {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  role      String
  content   String
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("chat_messages")
}

model ScheduledPayment {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  title       String
  amount      Decimal  @db.Decimal(12, 2)
  recipient   String
  frequency   String
  nextDueDate DateTime @map("next_due_date")
  isActive    Boolean  @default(true) @map("is_active")
  category    String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([userId, nextDueDate])
  @@map("scheduled_payments")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  action    String
  entity    String
  entityId  String?  @map("entity_id")
  oldData   Json?    @map("old_data")
  newData   Json?    @map("new_data")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([action, entity])
  @@map("audit_logs")
}

// ============================================
// PHASE 4: PIX, OPEN FINANCE & COMPLIANCE
// ============================================

// PIX Key Types
enum PixKeyType {
  CPF
  CNPJ
  EMAIL
  PHONE
  RANDOM
}

// PIX Transaction Status
enum PixTransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

// PIX Transaction Type
enum PixTransactionType {
  TRANSFER
  PAYMENT
  WITHDRAWAL
  QR_CODE
  SCHEDULED
}

// Open Finance Consent Status
enum ConsentStatus {
  PENDING
  AUTHORIZED
  REJECTED
  REVOKED
  EXPIRED
}

// Open Finance Data Types
enum OpenFinanceDataType {
  ACCOUNT_BALANCE
  TRANSACTIONS
  CREDIT_CARDS
  INVESTMENTS
  LOANS
}

// Fraud Alert Status
enum FraudAlertStatus {
  PENDING
  INVESTIGATING
  CONFIRMED
  FALSE_POSITIVE
  RESOLVED
}

// Fraud Alert Severity
enum FraudAlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// LGPD Consent Types
enum LgpdConsentType {
  DATA_PROCESSING
  MARKETING
  THIRD_PARTY_SHARING
  ANALYTICS
  AI_PERSONALIZATION
  BIOMETRIC
}

// Device Trust Level
enum DeviceTrustLevel {
  UNKNOWN
  LOW
  MEDIUM
  HIGH
  TRUSTED
}

// ============================================
// PIX MODELS
// ============================================

model PixKey {
  id            String      @id @default(uuid())
  userId        String      @map("user_id")
  accountId     String      @map("account_id")
  type          PixKeyType
  key           String      @unique
  isActive      Boolean     @default(true) @map("is_active")
  isPrimary     Boolean     @default(false) @map("is_primary")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  deactivatedAt DateTime?   @map("deactivated_at")

  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  sentPixTransactions     PixTransaction[] @relation("PixSender")
  receivedPixTransactions PixTransaction[] @relation("PixReceiver")

  @@index([userId])
  @@index([type, key])
  @@map("pix_keys")
}

model PixTransaction {
  id                  String               @id @default(uuid())
  userId              String               @map("user_id")
  senderKeyId         String?              @map("sender_key_id")
  receiverKeyId       String?              @map("receiver_key_id")
  externalReceiverKey String?              @map("external_receiver_key")
  type                PixTransactionType
  amount              Decimal              @db.Decimal(12, 2)
  description         String?
  status              PixTransactionStatus @default(PENDING)
  e2eId               String?              @unique @map("e2e_id")
  txId                String?              @map("tx_id")
  pspTransactionId    String?              @map("psp_transaction_id")
  scheduledFor        DateTime?            @map("scheduled_for")
  processedAt         DateTime?            @map("processed_at")
  failureReason       String?              @map("failure_reason")
  metadata            Json?
  fraudScore          Decimal?             @map("fraud_score") @db.Decimal(5, 2)
  fraudFlags          Json?                @map("fraud_flags")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  senderKey   PixKey?  @relation("PixSender", fields: [senderKeyId], references: [id])
  receiverKey PixKey?  @relation("PixReceiver", fields: [receiverKeyId], references: [id])

  @@index([userId, createdAt])
  @@index([status])
  @@index([e2eId])
  @@map("pix_transactions")
}

model PixWebhookEvent {
  id            String   @id @default(uuid())
  transactionId String?  @map("transaction_id")
  eventType     String   @map("event_type")
  payload       Json
  signature     String?
  isProcessed   Boolean  @default(false) @map("is_processed")
  processedAt   DateTime? @map("processed_at")
  errorMessage  String?  @map("error_message")
  retryCount    Int      @default(0) @map("retry_count")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([transactionId])
  @@index([eventType, isProcessed])
  @@map("pix_webhook_events")
}

model PixLimit {
  id              String   @id @default(uuid())
  userId          String   @unique @map("user_id")
  dailyLimit      Decimal  @default(5000) @map("daily_limit") @db.Decimal(12, 2)
  nightlyLimit    Decimal  @default(1000) @map("nightly_limit") @db.Decimal(12, 2)
  perTransactionLimit Decimal @default(2000) @map("per_transaction_limit") @db.Decimal(12, 2)
  monthlyLimit    Decimal  @default(50000) @map("monthly_limit") @db.Decimal(12, 2)
  usedToday       Decimal  @default(0) @map("used_today") @db.Decimal(12, 2)
  usedThisMonth   Decimal  @default(0) @map("used_this_month") @db.Decimal(12, 2)
  lastResetAt     DateTime @default(now()) @map("last_reset_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("pix_limits")
}

// ============================================
// OPEN FINANCE MODELS
// ============================================

model OpenFinanceInstitution {
  id              String   @id @default(uuid())
  name            String
  code            String   @unique
  logoUrl         String?  @map("logo_url")
  apiBaseUrl      String   @map("api_base_url")
  supportedScopes String[] @map("supported_scopes")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  consents        OpenFinanceConsent[]
  connections     OpenFinanceConnection[]

  @@map("open_finance_institutions")
}

model OpenFinanceConsent {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  institutionId   String        @map("institution_id")
  status          ConsentStatus @default(PENDING)
  scopes          String[]
  consentId       String?       @unique @map("consent_id")
  expiresAt       DateTime      @map("expires_at")
  authorizedAt    DateTime?     @map("authorized_at")
  revokedAt       DateTime?     @map("revoked_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  user        User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  institution OpenFinanceInstitution   @relation(fields: [institutionId], references: [id])
  connection  OpenFinanceConnection?

  @@index([userId, status])
  @@map("open_finance_consents")
}

model OpenFinanceConnection {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  consentId       String   @unique @map("consent_id")
  institutionId   String   @map("institution_id")
  accessToken     String?  @map("access_token")
  refreshToken    String?  @map("refresh_token")
  tokenExpiresAt  DateTime? @map("token_expires_at")
  lastSyncAt      DateTime? @map("last_sync_at")
  syncStatus      String   @default("pending") @map("sync_status")
  errorMessage    String?  @map("error_message")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user        User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  consent     OpenFinanceConsent     @relation(fields: [consentId], references: [id])
  institution OpenFinanceInstitution @relation(fields: [institutionId], references: [id])
  accounts    OpenFinanceAccount[]

  @@index([userId])
  @@map("open_finance_connections")
}

model OpenFinanceAccount {
  id            String   @id @default(uuid())
  connectionId  String   @map("connection_id")
  externalId    String   @map("external_id")
  accountType   String   @map("account_type")
  name          String
  balance       Decimal? @db.Decimal(12, 2)
  currency      String   @default("BRL")
  lastSyncAt    DateTime? @map("last_sync_at")
  metadata      Json?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  connection   OpenFinanceConnection   @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  transactions OpenFinanceTransaction[]

  @@unique([connectionId, externalId])
  @@map("open_finance_accounts")
}

model OpenFinanceTransaction {
  id            String   @id @default(uuid())
  accountId     String   @map("account_id")
  externalId    String   @map("external_id")
  amount        Decimal  @db.Decimal(12, 2)
  description   String
  category      String?
  date          DateTime
  type          String
  metadata      Json?
  createdAt     DateTime @default(now()) @map("created_at")

  account OpenFinanceAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, externalId])
  @@index([accountId, date])
  @@map("open_finance_transactions")
}

model OpenFinanceSyncLog {
  id            String   @id @default(uuid())
  connectionId  String   @map("connection_id")
  dataType      OpenFinanceDataType @map("data_type")
  recordsCount  Int      @default(0) @map("records_count")
  status        String
  errorMessage  String?  @map("error_message")
  startedAt     DateTime @map("started_at")
  completedAt   DateTime? @map("completed_at")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([connectionId, createdAt])
  @@map("open_finance_sync_logs")
}

// ============================================
// FRAUD DETECTION MODELS
// ============================================

model FraudRule {
  id            String   @id @default(uuid())
  name          String
  description   String?
  ruleType      String   @map("rule_type")
  conditions    Json
  score         Int      @default(10)
  isActive      Boolean  @default(true) @map("is_active")
  priority      Int      @default(0)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("fraud_rules")
}

model FraudAlert {
  id              String             @id @default(uuid())
  userId          String             @map("user_id")
  transactionId   String?            @map("transaction_id")
  transactionType String             @map("transaction_type")
  severity        FraudAlertSeverity @default(MEDIUM)
  status          FraudAlertStatus   @default(PENDING)
  score           Decimal            @db.Decimal(5, 2)
  triggeredRules  Json               @map("triggered_rules")
  details         Json?
  reviewedBy      String?            @map("reviewed_by")
  reviewedAt      DateTime?          @map("reviewed_at")
  resolution      String?
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([severity, status])
  @@map("fraud_alerts")
}

model UserRiskProfile {
  id                    String   @id @default(uuid())
  userId                String   @unique @map("user_id")
  riskScore             Decimal  @default(0) @map("risk_score") @db.Decimal(5, 2)
  transactionVelocity   Json?    @map("transaction_velocity")
  averageTransactionAmount Decimal? @map("avg_transaction_amount") @db.Decimal(12, 2)
  typicalHours          Json?    @map("typical_hours")
  typicalLocations      Json?    @map("typical_locations")
  deviceFingerprints    Json?    @map("device_fingerprints")
  flagCount             Int      @default(0) @map("flag_count")
  lastFlagAt            DateTime? @map("last_flag_at")
  isBlocked             Boolean  @default(false) @map("is_blocked")
  blockedReason         String?  @map("blocked_reason")
  blockedAt             DateTime? @map("blocked_at")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_risk_profiles")
}

model UserDevice {
  id              String          @id @default(uuid())
  userId          String          @map("user_id")
  fingerprint     String
  deviceType      String          @map("device_type")
  browser         String?
  os              String?
  ipAddress       String?         @map("ip_address")
  location        Json?
  trustLevel      DeviceTrustLevel @default(UNKNOWN) @map("trust_level")
  lastUsedAt      DateTime        @map("last_used_at")
  isActive        Boolean         @default(true) @map("is_active")
  createdAt       DateTime        @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, fingerprint])
  @@index([userId])
  @@map("user_devices")
}

// ============================================
// COMPLIANCE & LGPD MODELS
// ============================================

model LgpdConsent {
  id            String          @id @default(uuid())
  userId        String          @map("user_id")
  consentType   LgpdConsentType @map("consent_type")
  isGranted     Boolean         @default(false) @map("is_granted")
  version       String
  ipAddress     String?         @map("ip_address")
  userAgent     String?         @map("user_agent")
  grantedAt     DateTime?       @map("granted_at")
  revokedAt     DateTime?       @map("revoked_at")
  expiresAt     DateTime?       @map("expires_at")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, consentType])
  @@index([userId])
  @@map("lgpd_consents")
}

model DataRetentionPolicy {
  id              String   @id @default(uuid())
  entityType      String   @unique @map("entity_type")
  retentionDays   Int      @map("retention_days")
  description     String?
  isActive        Boolean  @default(true) @map("is_active")
  lastExecutedAt  DateTime? @map("last_executed_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("data_retention_policies")
}

model DataDeletionRequest {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  requestType   String   @map("request_type")
  status        String   @default("pending")
  reason        String?
  requestedAt   DateTime @default(now()) @map("requested_at")
  processedAt   DateTime? @map("processed_at")
  completedAt   DateTime? @map("completed_at")
  deletedData   Json?    @map("deleted_data")
  errorMessage  String?  @map("error_message")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@map("data_deletion_requests")
}

model ImmutableFinancialLog {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  eventType       String   @map("event_type")
  eventData       Json     @map("event_data")
  amount          Decimal? @db.Decimal(12, 2)
  balanceBefore   Decimal? @map("balance_before") @db.Decimal(12, 2)
  balanceAfter    Decimal? @map("balance_after") @db.Decimal(12, 2)
  hash            String   @unique
  previousHash    String?  @map("previous_hash")
  signature       String?
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([eventType])
  @@map("immutable_financial_logs")
}

// ============================================
// SECURITY MODELS
// ============================================

model MfaConfig {
  id              String   @id @default(uuid())
  userId          String   @unique @map("user_id")
  isEnabled       Boolean  @default(false) @map("is_enabled")
  method          String   @default("totp")
  secret          String?
  backupCodes     Json?    @map("backup_codes")
  lastUsedAt      DateTime? @map("last_used_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("mfa_configs")
}

model SecurityEvent {
  id            String   @id @default(uuid())
  userId        String?  @map("user_id")
  eventType     String   @map("event_type")
  severity      String
  description   String
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent")
  deviceId      String?  @map("device_id")
  metadata      Json?
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([eventType, severity])
  @@map("security_events")
}

model RateLimitRecord {
  id            String   @id @default(uuid())
  key           String
  endpoint      String
  count         Int      @default(1)
  windowStart   DateTime @map("window_start")
  windowEnd     DateTime @map("window_end")
  isBlocked     Boolean  @default(false) @map("is_blocked")
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([key, endpoint, windowStart])
  @@index([key, endpoint])
  @@map("rate_limit_records")
}

// ============================================
// PHASE 5: BILLING & MONETIZATION
// ============================================

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PIX
  BOLETO
}

model Plan {
  id              String   @id @default(uuid())
  code            String   @unique
  name            String
  description     String?
  priceMonthly    Decimal  @map("price_monthly") @db.Decimal(10, 2)
  priceYearly     Decimal  @map("price_yearly") @db.Decimal(10, 2)
  trialDays       Int      @default(0) @map("trial_days")
  features        Json
  limits          Json
  isActive        Boolean  @default(true) @map("is_active")
  sortOrder       Int      @default(0) @map("sort_order")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  subscriptions Subscription[]

  @@map("plans")
}

model Subscription {
  id                  String             @id @default(uuid())
  userId              String             @map("user_id")
  planId              String             @map("plan_id")
  status              SubscriptionStatus @default(TRIAL)
  currentPeriodStart  DateTime           @map("current_period_start")
  currentPeriodEnd    DateTime           @map("current_period_end")
  trialEndsAt         DateTime?          @map("trial_ends_at")
  cancelledAt         DateTime?          @map("cancelled_at")
  cancelReason        String?            @map("cancel_reason")
  externalId          String?            @map("external_id")
  metadata            Json?
  createdAt           DateTime           @default(now()) @map("created_at")
  updatedAt           DateTime           @updatedAt @map("updated_at")

  plan     Plan      @relation(fields: [planId], references: [id])
  payments Payment[]

  @@unique([userId])
  @@index([status])
  @@map("subscriptions")
}

model Payment {
  id              String        @id @default(uuid())
  subscriptionId  String?       @map("subscription_id")
  userId          String        @map("user_id")
  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("BRL")
  status          PaymentStatus @default(PENDING)
  paymentMethod   PaymentMethod @map("payment_method")
  externalId      String?       @map("external_id")
  description     String?
  failureReason   String?       @map("failure_reason")
  paidAt          DateTime?     @map("paid_at")
  refundedAt      DateTime?     @map("refunded_at")
  metadata        Json?
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  subscription Subscription? @relation(fields: [subscriptionId], references: [id])

  @@index([userId])
  @@index([status])
  @@map("payments")
}

model Invoice {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("BRL")
  status          PaymentStatus @default(PENDING)
  dueDate         DateTime      @map("due_date")
  paidAt          DateTime?     @map("paid_at")
  periodStart     DateTime      @map("period_start")
  periodEnd       DateTime      @map("period_end")
  items           Json
  externalId      String?       @map("external_id")
  pdfUrl          String?       @map("pdf_url")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  @@index([userId])
  @@index([status])
  @@map("invoices")
}

// ============================================
// PHASE 5: ANALYTICS & METRICS
// ============================================

model AnalyticsEvent {
  id          String   @id @default(uuid())
  userId      String?  @map("user_id")
  sessionId   String?  @map("session_id")
  eventName   String   @map("event_name")
  eventCategory String @map("event_category")
  properties  Json?
  deviceType  String?  @map("device_type")
  browser     String?
  os          String?
  country     String?
  city        String?
  referrer    String?
  utmSource   String?  @map("utm_source")
  utmMedium   String?  @map("utm_medium")
  utmCampaign String?  @map("utm_campaign")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([eventName, createdAt])
  @@index([eventCategory])
  @@map("analytics_events")
}

model UserMetrics {
  id                    String   @id @default(uuid())
  userId                String   @unique @map("user_id")
  totalLogins           Int      @default(0) @map("total_logins")
  totalTransactions     Int      @default(0) @map("total_transactions")
  totalAiInteractions   Int      @default(0) @map("total_ai_interactions")
  totalInsightsViewed   Int      @default(0) @map("total_insights_viewed")
  lastActiveAt          DateTime? @map("last_active_at")
  firstTransactionAt    DateTime? @map("first_transaction_at")
  firstAiInteractionAt  DateTime? @map("first_ai_interaction_at")
  activeDays            Int      @default(0) @map("active_days")
  currentStreak         Int      @default(0) @map("current_streak")
  longestStreak         Int      @default(0) @map("longest_streak")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("user_metrics")
}

model DailyMetrics {
  id                  String   @id @default(uuid())
  date                DateTime @db.Date
  totalUsers          Int      @default(0) @map("total_users")
  newUsers            Int      @default(0) @map("new_users")
  activeUsers         Int      @default(0) @map("active_users")
  totalTransactions   Int      @default(0) @map("total_transactions")
  transactionVolume   Decimal  @default(0) @map("transaction_volume") @db.Decimal(14, 2)
  totalRevenue        Decimal  @default(0) @map("total_revenue") @db.Decimal(14, 2)
  newSubscriptions    Int      @default(0) @map("new_subscriptions")
  cancelledSubs       Int      @default(0) @map("cancelled_subs")
  aiInteractions      Int      @default(0) @map("ai_interactions")
  pixTransactions     Int      @default(0) @map("pix_transactions")
  createdAt           DateTime @default(now()) @map("created_at")

  @@unique([date])
  @@map("daily_metrics")
}

// ============================================
// PHASE 5: GROWTH & REFERRAL
// ============================================

model ReferralCode {
  id          String   @id @default(uuid())
  userId      String   @unique @map("user_id")
  code        String   @unique
  usageCount  Int      @default(0) @map("usage_count")
  maxUses     Int?     @map("max_uses")
  reward      Decimal  @default(0) @db.Decimal(10, 2)
  isActive    Boolean  @default(true) @map("is_active")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  referrals Referral[]

  @@map("referral_codes")
}

model Referral {
  id              String   @id @default(uuid())
  referrerId      String   @map("referrer_id")
  referredUserId  String   @unique @map("referred_user_id")
  referralCodeId  String   @map("referral_code_id")
  status          String   @default("pending")
  rewardPaid      Boolean  @default(false) @map("reward_paid")
  rewardAmount    Decimal? @map("reward_amount") @db.Decimal(10, 2)
  convertedAt     DateTime? @map("converted_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  referralCode ReferralCode @relation(fields: [referralCodeId], references: [id])

  @@index([referrerId])
  @@map("referrals")
}

// ============================================
// PHASE 5: FEATURE FLAGS
// ============================================

model FeatureFlag {
  id          String   @id @default(uuid())
  key         String   @unique
  name        String
  description String?
  isEnabled   Boolean  @default(true) @map("is_enabled")
  plans       String[] @default([])
  percentage  Int      @default(100)
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("feature_flags")
}

model UserFeatureOverride {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  featureKey  String   @map("feature_key")
  isEnabled   Boolean  @map("is_enabled")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([userId, featureKey])
  @@map("user_feature_overrides")
}

// ============================================
// PHASE 5: EXPERIMENTS & A/B TESTING
// ============================================

model Experiment {
  id          String   @id @default(uuid())
  key         String   @unique
  name        String
  description String?
  status      String   @default("draft")
  variants    Json
  trafficSplit Json    @map("traffic_split")
  targetAudience Json? @map("target_audience")
  startedAt   DateTime? @map("started_at")
  endedAt     DateTime? @map("ended_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  assignments ExperimentAssignment[]

  @@map("experiments")
}

model ExperimentAssignment {
  id            String   @id @default(uuid())
  experimentId  String   @map("experiment_id")
  userId        String   @map("user_id")
  variant       String
  assignedAt    DateTime @default(now()) @map("assigned_at")

  experiment Experiment @relation(fields: [experimentId], references: [id])

  @@unique([experimentId, userId])
  @@map("experiment_assignments")
}

// ============================================
// USER RELATIONS UPDATE
// ============================================
